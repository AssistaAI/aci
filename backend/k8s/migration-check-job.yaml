apiVersion: batch/v1
kind: Job
metadata:
  name: aci-migrate-check-${BUILD_NUMBER}
  namespace: ${NAMESPACE}
  labels:
    app: aci-backend
    component: migration-check
    version: ${IMAGE_TAG}
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 1
  activeDeadlineSeconds: 60

  template:
    metadata:
      labels:
        app: aci-backend
        component: migration-check
    spec:
      restartPolicy: Never

      containers:
      - name: migrate-check
        image: ${FULL_IMAGE_NAME}
        command: ["sh", "-c"]
        args:
        - |
          echo "=== Current Migration Status ==="
          alembic current
          echo ""
          echo "=== Pending Migrations ==="
          alembic heads
          echo ""
          echo "=== Migration History ==="
          alembic history --verbose | head -20

        env:
        # Ensure PATH includes virtualenv
        - name: PATH
          value: /workdir/.venv/bin:/usr/local/bin:/usr/bin:/bin
        - name: PYTHONPATH
          value: /workdir

        # Common configuration used by Alembic models (encryption, AWS, etc.)
        - name: COMMON_AWS_ENDPOINT_URL
          value: "https://kms.us-east-1.amazonaws.com"

        - name: ALEMBIC_DB_SCHEME
          value: postgresql+psycopg
        - name: ALEMBIC_DB_PORT
          value: "5432"
        - name: ALEMBIC_DB_HOST
          value: aci-postgres-rw.${NAMESPACE}.svc.cluster.local
        - name: ALEMBIC_DB_USER
          valueFrom:
            secretKeyRef:
              name: aci-postgres-app
              key: username
        - name: ALEMBIC_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: aci-postgres-app
              key: password
        - name: ALEMBIC_DB_NAME
          valueFrom:
            secretKeyRef:
              name: aci-postgres-app
              key: dbname

        # Load shared application configuration (includes COMMON_AWS_REGION, KEY_ENCRYPTION_KEY_ARN, etc.)
        envFrom:
        - secretRef:
            name: aci-backend-${NAMESPACE}

        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
