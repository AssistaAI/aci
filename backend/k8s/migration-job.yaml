apiVersion: batch/v1
kind: Job
metadata:
  name: aci-migrate-${BUILD_NUMBER}
  namespace: ${NAMESPACE}
  labels:
    app: aci-backend
    component: migration
    version: ${IMAGE_TAG}
spec:
  # Only keep successful jobs for 1 hour, failed jobs for 24 hours
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3  # Retry up to 3 times on failure
  activeDeadlineSeconds: 300  # Timeout after 5 minutes

  template:
    metadata:
      labels:
        app: aci-backend
        component: migration
    spec:
      restartPolicy: Never

      containers:
      - name: migrate
        image: ${FULL_IMAGE_NAME}
        command: ["sh", "-c"]
        args: ["python3 -u test_migration.py && alembic upgrade head"]

        env:
        # Ensure PATH includes virtualenv
        - name: PATH
          value: /workdir/.venv/bin:/usr/local/bin:/usr/bin:/bin
        - name: PYTHONPATH
          value: /workdir

        # Database connection configuration
        - name: ALEMBIC_DB_SCHEME
          value: postgresql+psycopg
        - name: ALEMBIC_DB_PORT
          value: "5432"
        - name: ALEMBIC_DB_HOST
          value: aci-postgres-rw.${NAMESPACE}.svc.cluster.local
        - name: ALEMBIC_DB_USER
          valueFrom:
            secretKeyRef:
              name: aci-postgres-app
              key: username
        - name: ALEMBIC_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: aci-postgres-app
              key: password
        - name: ALEMBIC_DB_NAME
          valueFrom:
            secretKeyRef:
              name: aci-postgres-app
              key: dbname

        # Logging configuration
        - name: LOG_LEVEL
          value: INFO

        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

        # Security context
        # Note: Running as root for migration job to access virtualenv
        # This is acceptable as it's a short-lived, isolated job
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false  # Alembic needs to write temp files
          capabilities:
            drop:
            - ALL
