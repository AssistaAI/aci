name: Build and Deploy backend to DigitalOcean Kubernetes

on:
  push:
    branches: [main, dev]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deployment.yml'

env:
  REGISTRY: registry.digitalocean.com/assista-ai
  IMAGE_NAME: aci-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
    - uses: actions/checkout@v4
    
    - name: Set environment variables
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          BRANCH_NAME="prod"
          NAMESPACE="aci-prod"
          REPLICAS="3"
          POSTGRES_INSTANCES="2"
          DOMAIN="aci-api.assista.dev"
          APPLY_HPA="true"
        else
          BRANCH_NAME="dev"
          NAMESPACE="dev"
          REPLICAS="1"
          POSTGRES_INSTANCES="1"
          APPLY_HPA="false"
          DOMAIN="aci-api-dev.assista.dev"
        fi
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
        echo "NAMESPACE=${NAMESPACE}" >> $GITHUB_ENV
        echo "REPLICAS=${REPLICAS}" >> $GITHUB_ENV
        echo "POSTGRES_INSTANCES=${POSTGRES_INSTANCES}" >> $GITHUB_ENV
        echo "APPLY_HPA=${APPLY_HPA}" >> $GITHUB_ENV
        echo "DOMAIN=${DOMAIN}" >> $GITHUB_ENV
        echo "IMAGE_TAG=${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_ENV
        echo "FULL_IMAGE_NAME=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_ENV
    
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
    
    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login --expiry-seconds 1200
    
    - name: Build and push backend
      run: |
        docker build -f Dockerfile.server.prod -t ${{ env.FULL_IMAGE_NAME }} .
        docker push ${{ env.FULL_IMAGE_NAME }}
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: "latest"
    
    - name: Load Kubeconfig
      
      run: |
        if [ "${{ github.ref_name }}" = "main" ]; then
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
        else
          echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > kubeconfig
        fi
        export KUBECONFIG=kubeconfig
        # Verify connection
        kubectl cluster-info
        kubectl get nodes
    
    - name: Check Migration Status (Pre-Deployment)
      run: |
        export KUBECONFIG=kubeconfig
        export BUILD_NUMBER="${{ github.run_number }}-pre"

        echo "=== Checking current migration status before deployment ==="

        # Apply migration check job
        envsubst '${NAMESPACE} ${FULL_IMAGE_NAME} ${IMAGE_TAG} ${BUILD_NUMBER}' < k8s/migration-check-job.yaml | kubectl apply -f -

        # Wait for check job to complete (max 60 seconds)
        kubectl wait --for=condition=complete --timeout=60s job/aci-migrate-check-${BUILD_NUMBER} -n ${{ env.NAMESPACE }} || true

        # Show migration check output
        kubectl logs job/aci-migrate-check-${BUILD_NUMBER} -n ${{ env.NAMESPACE }} || echo "Unable to retrieve migration check logs"

        # Clean up check job
        kubectl delete job aci-migrate-check-${BUILD_NUMBER} -n ${{ env.NAMESPACE }} --ignore-not-found=true
      env:
        NAMESPACE: ${{ env.NAMESPACE }}
        FULL_IMAGE_NAME: ${{ env.FULL_IMAGE_NAME }}
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      continue-on-error: true  # Don't fail deployment if check fails

    - name: Run Database Migrations
      run: |
        export KUBECONFIG=kubeconfig
        export BUILD_NUMBER="${{ github.run_number }}"

        echo "=== Running database migrations ==="

        # Apply migration job
        envsubst '${NAMESPACE} ${FULL_IMAGE_NAME} ${IMAGE_TAG} ${BUILD_NUMBER}' < k8s/migration-job.yaml | kubectl apply -f -

        # Wait for migration job to complete (max 5 minutes)
        echo "Waiting for migration job to complete..."
        if kubectl wait --for=condition=complete --timeout=300s job/aci-migrate-${BUILD_NUMBER} -n ${{ env.NAMESPACE }}; then
          echo "✅ Migrations completed successfully"
          kubectl logs job/aci-migrate-${BUILD_NUMBER} -n ${{ env.NAMESPACE }}
        else
          echo "❌ Migration job failed or timed out"

          # Get all pods for this job
          echo "=== Getting pod information ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l job-name=aci-migrate-${BUILD_NUMBER} -o wide

          # Try to get logs from all pods - use jsonpath to get pod names
          echo "=== Attempting to retrieve logs from all pods ==="
          POD_NAMES=$(kubectl get pods -n ${{ env.NAMESPACE }} -l job-name=aci-migrate-${BUILD_NUMBER} -o jsonpath='{.items[*].metadata.name}')

          if [ -z "$POD_NAMES" ]; then
            echo "❌ No pods found for job aci-migrate-${BUILD_NUMBER}"
          else
            for pod_name in $POD_NAMES; do
              echo "========================================"
              echo "=== LOGS FROM POD: $pod_name ==="
              echo "========================================"
              kubectl logs -n ${{ env.NAMESPACE }} $pod_name --all-containers=true --tail=200 2>&1 || echo "⚠️  Could not retrieve logs from $pod_name"

              echo ""
              echo "========================================"
              echo "=== POD DESCRIPTION: $pod_name ==="
              echo "========================================"
              kubectl describe -n ${{ env.NAMESPACE }} pod/$pod_name 2>&1 || echo "⚠️  Could not describe $pod_name"
              echo ""
            done
          fi

          # Check job status
          echo "========================================"
          echo "=== JOB DESCRIPTION ==="
          echo "========================================"
          kubectl describe job aci-migrate-${BUILD_NUMBER} -n ${{ env.NAMESPACE }}

          # Check events
          echo ""
          echo "========================================"
          echo "=== RECENT EVENTS IN NAMESPACE ==="
          echo "========================================"
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -30

          # Fail the workflow
          exit 1
        fi

        # Clean up successful migration job after 1 hour (handled by ttlSecondsAfterFinished)
        echo "Migration job will be automatically cleaned up after 1 hour"
      env:
        NAMESPACE: ${{ env.NAMESPACE }}
        FULL_IMAGE_NAME: ${{ env.FULL_IMAGE_NAME }}
        IMAGE_TAG: ${{ env.IMAGE_TAG }}

    - name: Deploy to Kubernetes
      run: |
        export KUBECONFIG=kubeconfig

        # Verify envsubst is available (should be pre-installed)
        which envsubst || sudo apt-get update && sudo apt-get install -y gettext-base

        # Process and apply manifests
        envsubst '${NAMESPACE}' < k8s/namespace.yaml | kubectl apply -f -
        envsubst '${NAMESPACE} ${POSTGRES_INSTANCES}' < k8s/postgres.yaml | kubectl apply -f -
        envsubst '${NAMESPACE} ${FULL_IMAGE_NAME} ${REPLICAS}' < k8s/deployment.yaml | kubectl apply -f -
        envsubst '${NAMESPACE}' < k8s/service.yaml | kubectl apply -f -
        envsubst '${NAMESPACE} ${DOMAIN}' < k8s/ingress.yaml | kubectl apply -f -

        # Apply HPA when enabled
        if [ "${{ env.APPLY_HPA }}" = "true" ]; then
          envsubst '${NAMESPACE}' < k8s/hpa.yaml | kubectl apply -f -
        fi

        # Wait for deployment
        kubectl rollout status deployment/aci-backend -n ${{ env.NAMESPACE }} --timeout=300s
      env:
        NAMESPACE: ${{ env.NAMESPACE }}
        FULL_IMAGE_NAME: ${{ env.FULL_IMAGE_NAME }}
        REPLICAS: ${{ env.REPLICAS }}
        POSTGRES_INSTANCES: ${{ env.POSTGRES_INSTANCES }}
        APPLY_HPA: ${{ env.APPLY_HPA }}

    - name: Verify Migration Status (Post-Deployment)
      run: |
        export KUBECONFIG=kubeconfig
        export BUILD_NUMBER="${{ github.run_number }}-post"

        echo "=== Verifying final migration status after deployment ==="

        # Apply migration check job
        envsubst '${NAMESPACE} ${FULL_IMAGE_NAME} ${IMAGE_TAG} ${BUILD_NUMBER}' < k8s/migration-check-job.yaml | kubectl apply -f -

        # Wait for check job to complete
        kubectl wait --for=condition=complete --timeout=60s job/aci-migrate-check-${BUILD_NUMBER} -n ${{ env.NAMESPACE }} || true

        # Show final migration status
        kubectl logs job/aci-migrate-check-${BUILD_NUMBER} -n ${{ env.NAMESPACE }} || echo "Unable to retrieve migration verification logs"

        # Clean up check job
        kubectl delete job aci-migrate-check-${BUILD_NUMBER} -n ${{ env.NAMESPACE }} --ignore-not-found=true
      env:
        NAMESPACE: ${{ env.NAMESPACE }}
        FULL_IMAGE_NAME: ${{ env.FULL_IMAGE_NAME }}
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      continue-on-error: true 